## Codebase Patterns

- GitLab API client is injected into the Model via NewModel() constructor
- Use async command pattern for API calls: define Msg type (e.g., commentsLoadedMsg), create command function (e.g., loadCommentsCmd), handle in Update()
- State enums (DetailSection, ViewMode, IssueFilterState) need String() method for display
- Tab key behavior is context-dependent: toggles sections in detail view, switches views otherwise
- Check view-specific state (len(m.items) > 0 && m.selectedItem < len(m.items)) before showing section-specific UI
- gitlab.Note.Author is a struct, not a pointer - check empty string instead of nil
- GitLab SDK types (gitlab.Issue, gitlab.Note) are used in model, but local gitlab package provides API wrapper
- Import aliasing needed when importing both gitlab SDK and local pkg/gitlab package (use `gl` alias for local package)
- Confirmation popups should be checked before error popups (higher priority) in both Update() and View() methods
- When updating state in-place (e.g., after API call), update both items[i] and selectedIssue to keep UI in sync

## 2026-01-17 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added DetailSection enum (DescriptionSection, CommentsSection) with String() method
- Added commentsLoadedMsg, commentsLoadedErrMsg message types for async loading
- Added selectedComments []*gitlab.Note field to Model
- Added gitlabClient interface to Model for dependency injection (allows mocking)
- Created loadCommentsCmd() function to fetch comments via API
- Updated Tab key handler: toggles detail sections in IssuesView, switches views otherwise
- Updated Enter key handler in IssuesView: loads comments when issue selected, resets to DescriptionSection
- Updated renderDetailsPanel: shows description or comments based on detailSection state
- Updated status bar: shows current view (Description/Comments) and comment count
- Modified main.go: create GitLab client and inject into Model

**Learnings for future iterations:**
- When adding new detail sections, follow the DetailSection pattern: create enum type with String() method
- API calls should be async using tea.Cmd pattern: define Msg type, create command function, handle in Update()
- GitLab client must be created in main.go and injected into Model via NewModel()
- When adding gitlab package imports, use aliasing to avoid conflicts with SDK types
- For state-dependent key handlers (like Tab), check context first (currentView + selection state)
- gitlab.Note.Author is a struct, check .Username field directly (not nil)
- Loading state: set isLoading=true before command, set isLoading=false in message handler
 - Comment display limit: use maxCommentLines constant and show "+N more" indicator
 - Error handling: use SetError() helper and show error popup via renderErrorPopup()
 ---

## 2026-01-17 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added CreateIssueOptions struct with Title and Description fields
- Added CreateIssue method to Client interface
- Implemented CreateIssue method in client struct: calls gitlab.Issues.CreateIssue with proper options
- Added createIssueErr field to mockClient struct in client_test.go
- Added CreateIssue method to mockClient in client_test.go: returns m.issue, m.createIssueErr

**Learnings for future iterations:**
- Follow established pattern when adding API methods: Options struct → Client interface → client implementation → mock implementation
- GitLab SDK's CreateIssue method takes gitlab.CreateIssueOptions with pointer fields (Title, Description)
- Map local options struct to SDK options struct by checking non-empty values and setting pointers
- Return nil error with wrapped context: fmt.Errorf("context: %w", err)
- Always check for nil responses from API and return descriptive error
- Mock implementation pattern: return mock data from struct fields, allow error injection via error field
---

## 2026-01-17 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added showCreateIssueForm, issueFormTitle, issueFormDesc, issueFormField fields to Model
- Added CreateIssue method to gitlabClient interface in GUI package
- Added issueCreatedMsg and issueCreatedErrMsg message types for async issue creation
- Created createIssueCmd() function to handle async API call
- Updated Update() method to handle create issue form key events:
  - Tab switches between title and description fields
  - Enter switches to next field or submits if at description
  - Ctrl+Enter submits the form
  - Esc cancels the form
  - Regular characters are added to the active field
  - Backspace removes characters from active field
- Added 'c' key handler in IssuesView to open create issue form
- Updated View() method to show create issue form popup when active
- Created renderCreateIssueForm() method to render the form with title and description fields
- Form shows current field indicator (sidebarActive style) and cursor placeholder (_)
- After successful creation, form closes and fields are reset

**Learnings for future iterations:**
- For form state management, use boolean flag (showCreateIssueForm) and check it first in Update/View methods
- Handle text input by checking msg.Type == tea.KeyRunes and msg.Type == tea.KeyBackspace
- Use msg.String() for single-character checks like 'c' but check msg.Type for input handling
- Active field indicator can be implemented by toggling between style assignments based on field state
- Cursor placeholder (_) helps users understand where input will be entered
- Form validation (e.g., required title check) should happen in the submit handler, not during input
- Reset all form fields when closing form (both on cancel and successful submit)
- Async API calls follow pattern: create Msg type, create Cmd function, handle in Update method
- Form rendering should show all fields but highlight the active one with different style
---

## 2026-01-17 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added UpdateIssueOptions struct with Title, Description, and StateEvent fields
- Added UpdateIssue method to Client interface in gitlab package
- Implemented UpdateIssue method in client struct: calls gitlab.Issues.UpdateIssue with proper options
- Added updateIssueErr field to mockClient struct in client_test.go
- Added UpdateIssue method to mockClient in client_test.go: returns m.issue, m.updateIssueErr

**Learnings for future iterations:**
- Follow established pattern for update operations similar to create operations: Options struct → Client interface → client implementation → mock implementation
- GitLab SDK's UpdateIssue method takes gitlab.UpdateIssueOptions with pointer fields
- StateEvent field accepts values like "reopen" or "close" to toggle issue state
- Map local options struct to SDK options struct by checking non-empty values and setting pointers
- Return nil error with wrapped context: fmt.Errorf("failed to update issue %d in project %s: %w", issueIID, projectPath, err)
- Always check for nil responses from API and return descriptive error
---

## 2026-01-17 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added issueUpdatedMsg and issueUpdatedErrMsg message types for async issue updates
- Added showConfirmPopup, confirmAction, and confirmIssueIID fields to Model
- Added UpdateIssue method to gitlabClient interface in GUI package
- Created updateIssueCmd() function to handle async API call
- Added 'o' key handler in IssuesView to show confirmation popup
- Added confirmation popup key handlers: 'y' for confirm, 'n'/'esc' for cancel
- Created renderConfirmPopup() method with rounded border and blue/purple theme
- In issueUpdatedMsg handler: updates items[i].State and selectedIssue.State, resets confirmation state
- Added confirmation popup check before error popup in Update() and View() methods
- After successful update, confirmation state is reset (showConfirmPopup, confirmAction, confirmIssueIID)

**Learnings for future iterations:**
- Confirmation popups need three state fields: show flag, action description, and affected item ID
- Check showConfirmPopup before showError in both Update() and View() methods (confirmation has higher priority)
- When updating list items in-place after API call, update both items array and selectedIssue reference
- Use strings.Title() to capitalize action text (e.g., "close" → "Close") in confirmation popup
- Toggle action based on current state: check item.State to determine whether to "close" or "reopen"
- StateEvent values for UpdateIssue: "reopen" to open, "close" to close
- Reset all confirmation state fields when closing popup (both on confirm and cancel)
 - Confirmation popup styling: use lipgloss.Color("62") for border to match app theme
 
## 2026-01-17 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created pkg/utils/clipboard.go with OS-specific clipboard operations (xclip for Linux, pbcopy for macOS, clip for Windows)
- Added clipboardMessage field to Model for displaying clipboard confirmation in status bar
- Added clipboardClearMsg message type for auto-hiding clipboard message after 3 seconds
- Added 'y' key handler in IssuesView to copy issue URL to clipboard
- Updated renderStatusBar() to show clipboard message when set (takes priority over normal status)
- Created pkg/utils/clipboard_test.go with basic tests
- Files changed: pkg/utils/clipboard.go (new), pkg/utils/clipboard_test.go (new), pkg/gui/model.go (modified)

**Learnings for future iterations:**
- For temporary status messages (like clipboard confirmation), use a string field in Model and tea.Tick for auto-hide
- tea.Tick(duration, func(time.Time) tea.Msg) returns a command that sends a message after specified time
- Status bar can be overridden completely when showing temporary messages by checking message field first and returning early
- OS detection: use runtime.GOOS to detect Linux, Darwin, Windows at runtime
- Clipboard tools: xclip on Linux (selection clipboard), pbcopy on macOS, clip on Windows
- Error handling: check exec.Error type to detect if command was not found (e.g., xclip not installed)
 - Test short mode: use testing.Short() to skip integration tests that require external tools
- Import utils package in GUI to access clipboard functionality
- Issue URL format: https://gitlab.com/{projectPath}/-/issues/{issueIID}
---

## 2026-01-17 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created pkg/utils/browser.go with OS-specific browser open functions (xdg-open for Linux, open for macOS, start for Windows)
- Added 'b' key handler in IssuesView to open issue URL in default browser
- Added error handling with SetError() if browser launch fails
- No success message needed since browser opening is visible to user
- Files changed: pkg/utils/browser.go (new), pkg/gui/model.go (modified)

**Learnings for future iterations:**
- Browser utilities follow same pattern as clipboard utilities: OS detection with runtime.GOOS, separate function for each OS
- For Linux: use xdg-open command with cmd.Start() (non-blocking) instead of cmd.Run() (blocking)
- Error handling: check exec.Error type to detect if command was not found (e.g., xdg-utils not installed)
- User feedback: not needed for successful browser open since it's visible, only show error on failure
- Import utils package in GUI to access browser functionality
- Issue URL format: https://gitlab.com/{projectPath}/-/issues/{issueIID}
---

## 2026-01-17 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added CreateIssueNote method to gitlabClient interface in GUI package
- Added commentCreatedMsg and commentCreatedErrMsg message types for async comment creation
- Added showCommentForm and commentFormBody fields to Model for comment form state
- Created createCommentCmd() function to handle async API call
- Updated Update() method to handle comment form key events:
  - Esc cancels the form
  - Ctrl+Enter submits the form
  - Regular characters are added to the comment body
  - Backspace removes characters from comment body
- Added 'r' key handler in IssuesView (CommentsSection only) to open comment form
- Updated View() method to show comment form popup when active
- Created renderCommentForm() method to render the form with multiline text input
- After successful creation, form closes, fields reset, and comments are reloaded
- Files changed: pkg/gui/model.go (modified)

**Learnings for future iterations:**
- Follow async pattern for API calls: create Msg type, create Cmd function, handle in Update method
- Comment form only shows when in IssuesView with an issue selected and in CommentsSection
- Multiline text input handling: use strings.Split to manage lines, show cursor placeholder (_) at end
- After successful comment creation, reload comments to show new comment in list
- Form validation (e.g., required body check) happens in submit handler, not during input
- Reset all form fields when closing form (both on cancel and successful submit)
- Check m.detailSection == CommentsSection before showing comment form to ensure proper context
---

